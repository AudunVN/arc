<!DOCTYPE html>
<html>
	<head>
		<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<script src="smoothie.js"></script>
		<style>
			@font-face {
				font-family: unifont;
				src: url("https://24e3021dd42ba493ca4b980e89f1158d0706cb0f.googledrive.com/host/0B-jbiuTm6FjRVUdKSWRnRFlLS0k/unifont-8.0.01.ttf");
			}
			
			html {
				background: black;
			}

			.appContainer {
				position: absolute;
				background-color: #001;
				margin: 0 auto;
				border: 2px solid #13B;
				padding: 0.5em;
				font-family: unifont, sans-serif;
				font-size: 16px;
				color: white;
				left: 0.25em;
				right: 0.25em;
			}

			.ioContainer {
				margin: 0;
				padding: 0;
				width: 100%;
				height: 100%;
			}

			.uiContainer {
				display: block;
				height: 50%;
				position: relative;
				border: 1px solid #13B;
				padding: 0.2em;
				text-align: center;
				padding-bottom: 0em;
			}

			/* button styles begin */

			.inputRow {
				margin-bottom: 0.5em;
				text-align: center;
			}

			.button {
				margin-top: 0.5em;
				min-width: 1em;
				min-height: 1em;
				border: 1px solid #13B;
				display: inline-block;
				padding: 0.5em;
				padding-top: 0.3em;
				cursor: pointer;
			}
			
			.button[data-state="inactive"] {
				background: #961717;
			}
			
			.button[data-state="active"] {
				background: #00B600;
			}
			
			.button:hover {
				background: orange;
			}
			/* button styles end */

			/* terminal styles begin */
			.term {
				overflow-y: auto;
				overflow-x: hidden;
				width: 100%;
				height: 5em;
				border: 1px solid #13B;
				resize: vertical;
			}

			.term .outputLine {
				width: 100%;
				min-height: 1em;
				display: inline-block;
				/*#BB6622*/
				color: orange;
			}

			.termInput {
				position: relative;
				width: 100%;
				height: 1em;
				border: 1px solid #13B;
				border-top: none;
				font-size: 1em;
				padding-bottom: 0.2em;
			}

			.termInput .inputIndicator {
				position: absolute;
				left: 0.35em;
			}

			.termInput input {
				display: block;
			    position: absolute;
				border: 0;
				padding: 0;
				left: 1em;
				right: 0;
				top: 0;
				width: 90%;
				bottom: 0;
				background-color: transparent;
				color: white;
				font-size: 1em;
				font-family: unifont, sans-serif;
			}

			.term .outputLine:nth-child(even) {background: #060136}
			.term .outputLine:nth-child(odd) {background: #010613}
			/* terminal styles end */
			
			/* graph styles begin */
			.graph {
				min-height: 7em;
				min-width: 7em;
				display: inline-block;
				position: relative;
				height: 100%;
				border: 1px solid #13B;
				margin: 0px;
				box-sizing: border-box;
				background-image: url("http://qipeace.com/images/SineGoldSide.png");
				background-size: contain;
				background-repeat: repeat-x;
				background-position: 50% 50%;
				margin-left: -0.15em;
				margin-bottom: 0.1em;
				resize: horizontal;
				overflow-x: auto;
				max-width: 100%;
			}
			
			.graph label {
				position: absolute;
				z-index: 2;
				padding-left: 0.15em;
				padding-right: 0.15em;
			}
			
			.graph label.graphName {
				left: 0;
				top: 0;
			}
			
			.graph label.maxValue {
				right: 0;
				top: 0;
			}
			.graph label.minValue {
				right: 0;
				bottom: 0;
			}
			.graph label.currentValue {
				left: 0;
				bottom: 0;
			}
			/* graph styles end */

			/* meter styles begin */
			.meter {
				min-height: 7em;
				display: inline-block;
				position: relative;
				height: 100%;
				width: 1em;
				border: 1px solid #13B;
				margin: 0px;
				box-sizing: border-box;
				margin-left: -0.15em;
				margin-bottom: 0.1em;
			}

			.meter label {
				position: absolute;
				z-index: 2;
				word-wrap: break-word;
				width: 100%;
				left: 0;
				top: 50%;
				transform: translateY(-50%);
				vertical-align: center;
				margin: 0 auto;
				right: 0;
			}

			.meter .meterState {
				top: 100%;
				bottom: 0;
				left: 0;
				right: 0;
				margin: auto;
				position: absolute;
				background-color: #13B;
				transition: top linear 0.5s;
			}

			.meter.throttleMeter .meterState {
				top: 60%;
			}

			.meter.fuelMeter .meterState {
				top: 10%;
			}

			.meter.rhoMeter .meterState {
				top: 90%;
			}
			/* meter styles end */
		</style>
	</head>
	<body>
		<div class="appContainer">
			<div class="ioContainer">
				<div class="uiContainer">
					<div class="meter throttleMeter">
						<label>THR</label>
						<div class="meterState"></div>
						<span class="meterValue"></span>
					</div>
					<div class="meter lfMeter">
						<label>LF</label>
						<div class="meterState"></div>
						<span class="meterValue"></span>
					</div>
					<div class="meter loMeter">
						<label>OX</label>
						<div class="meterState"></div>
						<span class="meterValue"></span>
					</div>
					<div class="meter rcsMeter">
						<label>RCS</label>
						<div class="meterState"></div>
						<span class="meterValue"></span>
					</div>
					<div class="meter pitchMeter">
						<label>PTCH</label>
						<div class="meterState"></div>
						<span class="meterValue"></span>
					</div>
					<div class="meter yawMeter">
						<label>YAW</label>
						<div class="meterState"></div>
						<span class="meterValue"></span>
					</div>
					<div class="meter rollMeter">
						<label>ROLL</label>
						<div class="meterState"></div>
						<span class="meterValue"></span>
					</div>
					<div class="meter altMeter">
						<label>3 ALT</label>
						<div class="meterState"></div>
						<span class="meterValue"></span>
					</div>
					<div class="meter aglMeter">
						<label>0 AGL</label>
						<div class="meterState"></div>
						<span class="meterValue"></span>
					</div>
					<div class="meter rhoMeter">
						<label>ATM</label>
						<div class="meterState"></div>
						<span class="meterValue"></span>
					</div>
					<div class="meter battMeter">
						<label>BATT</label>
						<div class="meterState"></div>
						<span class="meterValue"></span>
					</div>
					<div class="graph altGraph">
						<label class="graphName">ALT</label>
						<label class="maxValue">10^3</label>
						<label class="minValue">0</label>
						<label class="currentValue">786</label>
						<div class="meterState"></div>
						<span class="meterValue"></span>
					</div>
					<div class="graph fuelGraph">
						<label class="graphName">LF</label>
						<label class="maxValue">10^3</label>
						<label class="minValue">0</label>
						<label class="currentValue">786</label>
						<div class="meterState"></div>
						<span class="meterValue"></span>
					</div>
					<div class="graph battGraph">
						<label class="graphName">BATT</label>
						<label class="maxValue">10^3</label>
						<label class="minValue">0</label>
						<label class="currentValue">786</label>
						<div class="meterState"></div>
						<span class="meterValue"></span>
					</div>
				</div>
				<div class="inputRow">
					<div class="button" onclick="doApiRequest('f.stage')">STAGE</div>
					<div class="button" onclick="doApiRequest('f.abort')">ABORT</div>
					<div class="button" onclick="doApiRequest('f.throttleZero')">SAS</div>
					<div class="button" onclick="doApiRequest('f.throttleZero')">RCS</div>
					<div class="button" data-state="inactive" onclick="doApiRequest('f.throttleZero')">LIGHT</div>
					<div class="button" data-state="active" onclick="doApiRequest('f.throttleZero')">GEARS</div>
					<div class="button" onclick="doApiRequest('f.throttleUp')">T+</div>
					<div class="button" onclick="doApiRequest('f.throttleDown')">T-</div>
					<div class="button" onclick="doApiRequest('f.throttleZero')">T->0</div>
					<div class="button" onclick="doApiRequest('f.throttleZero')">ACT1</div>
					<div class="button" onclick="doApiRequest('f.throttleZero')">ACT2</div>
					<div class="button" onclick="doApiRequest('f.throttleZero')">ACT3</div>
					<div class="button" onclick="doApiRequest('f.throttleZero')">ACT4</div>
					<div class="button" onclick="doApiRequest('f.throttleZero')">ACT5</div>
					<div class="button" onclick="doApiRequest('f.throttleZero')">ACT6</div>
					<div class="button" onclick="doApiRequest('f.throttleZero')">ACT7</div>
					<div class="button" onclick="doApiRequest('f.throttleZero')">ACT8</div>
					<div class="button" onclick="doApiRequest('f.throttleZero')">ACT9</div>
					<div class="button" onclick="doApiRequest('f.throttleZero')">ACT0</div>
				</div>
				<div class="term">
				</div>
				<div class="termInput"><span class="inputIndicator">></span><input type="text"></div>
			</div>
		</div>
		<script>
			var URL = "127.0.0.1:8085";
			var updateRate = 100;
			var updateThrottle = 10000;

			function doApiRequest(apiString) {
				$.get("http://"+URL+"/telemachus/datalink?a="+apiString).success(function(data) {
					log(".term","Command \""+apiString+"\" issued to active vessel.","&nbsp;>");
					return $.parseJSON(data);
				}).error(function(jqXHR, textStatus, errorThrown) {
					log(".term","Command \""+apiString+"\" failed: Unable to contact vessel.","&nbsp;>");
				});
			}
			
			function log(terminalIdentifier, outputString, timestamp) {
				$(terminalIdentifier).append('<div class="outputLine"><span class="timestamp">'+timestamp+'</span> <span class="output">'+outputString+'</span></div>');
				$(terminalIdentifier).animate({scrollTop:$(terminalIdentifier)[0].scrollHeight}, 1000);
			}
			
			function updateInterface() {
				var requestString = "throttle=f.throttle";
				requestString += "&lfmax=r.resourceMax[LiquidFuel]";
				requestString += "&lomax=r.resourceMax[Oxidizer]";
				requestString += "&lf=r.resource[LiquidFuel]";
				requestString += "&lo=r.resource[Oxidizer]";
				requestString += "&mTime=v.missionTime";
				$.get("http://"+URL+"/telemachus/datalink?"+requestString).success(function(data) {
					updateThrottle = 0;
					var parsedData = $.parseJSON(data);
					document.querySelector(".meter.throttleMeter .meterState").style.top = 100-parsedData.throttle*100+"%";
					document.querySelector(".meter.lfMeter .meterState").style.top = 100-(parsedData.lf/parsedData.lfmax)*100+"%";
					document.querySelector(".meter.loMeter .meterState").style.top = 100-(parsedData.lo/parsedData.lomax)*100+"%";
					log(".term","Test.","T+"+Math.round(Number(parsedData.mTime)));
				}).error(function(jqXHR, textStatus, errorThrown) {
					updateThrottle = 10000;
					log(".term","Interface update failed: Unable to contact vessel. Retrying in ten seconds.","&nbsp;>");
				});
				setTimeout(function(){ updateInterface(); }, updateRate+updateThrottle);
			}

			$(".termInput input").keyup(function(key) {
				if (key.keyCode == 13) {
					var termInput = document.querySelector(".termInput input").value;
					var sanitizedInput = termInput.toLowerCase().trim();
					log(".term",termInput,"&nbsp;<");
					document.querySelector(".termInput input").value = "";
					switch(sanitizedInput) {
						case "help": {
							log(".term","Haven't got any help for you yet, sorry.","&nbsp;>");
							break;
						}
						default: {
							log(".term","Invalid or unknown command.","&nbsp;>");
							break;
						}
					}
				}
			});
			
			log(".term","Console output started.","T-X");
			
			updateInterface();
		</script>
	</body>
</html>
